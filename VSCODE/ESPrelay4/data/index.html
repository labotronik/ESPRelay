<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESPRelay</title>
  <style>
    :root { --b:#ddd; --bg:#f7f7f7; }
    body{font-family:system-ui,Arial;margin:16px;max-width:1200px}
    body.dark{--b:#3c3c3c;--bg:#1f1f1f;background:#121212;color:#eee}
    h1{margin:0 0 8px 0}
    .tabs{display:flex;gap:8px;margin:12px 0}
    .tab{padding:8px 10px;border:1px solid var(--b);border-radius:10px;background:#fff;cursor:pointer}
    .tab.active{background:var(--bg);font-weight:700}
    .tab.disabled{opacity:.5;pointer-events:none}
    .tabs.sub{margin:8px 0}
    .tab.sub{padding:6px 8px;font-size:.9em}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:stretch}
    .modules{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .module-card{border:1px solid var(--b);border-radius:12px;padding:10px;background:#fff}
    .card{border:1px solid var(--b);border-radius:14px;padding:12px;min-width:260px;background:#fff}
    .grid4{display:grid;grid-template-columns:repeat(2,minmax(320px,1fr));gap:12px}
    @media(min-width:1100px){ .grid4{grid-template-columns:repeat(4,minmax(260px,1fr));} }
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(320px,1fr));gap:12px}
    .on{font-weight:800}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--b);border-radius:999px;font-size:.85em;background:var(--bg)}
    .pill.shutter{background:#eee;color:#555;border-color:#ccc}
    .hb-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#27c046;margin-right:6px;animation:hb 1s steps(1,end) infinite}
    @keyframes hb{50%{opacity:.2}}
    button{padding:8px 10px;border-radius:10px;border:1px solid #aaa;background:#fff;cursor:pointer}
    button.primary{background:var(--bg);font-weight:700}
    button.small{padding:6px 8px;font-size:.9em}
    select,input[type="number"],input[type="text"]{padding:6px 8px;border-radius:10px;border:1px solid var(--b)}
    label{user-select:none}
    .muted{color:#666}
    .sep{height:1px;background:var(--b);margin:10px 0}
    .ok{color:#0a7a2f;font-weight:700}
    .err{color:#b00020;font-weight:700}
    pre{background:#fafafa;border:1px solid var(--b);padding:10px;border-radius:12px;overflow:auto}
    .hide{display:none}
    .inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .lang{margin-left:auto;display:flex;gap:6px}
    .flag{border:1px solid var(--b);border-radius:999px;padding:4px 8px;background:#fff;cursor:pointer;font-size:1.1em}
    .flag.active{background:var(--bg);font-weight:700}
    .chip{border:1px solid var(--b);border-radius:999px;padding:6px 10px;background:var(--bg)}
    .notice{padding:8px 10px;border:1px dashed var(--b);border-radius:10px;background:#fff}
    body.dark .card,
    body.dark .module-card,
    body.dark .tab,
    body.dark .pill,
    body.dark .chip,
    body.dark pre,
    body.dark .notice{background:#1a1a1a;color:#eee;border-color:var(--b)}
    body.dark .tab.active{background:#262626}
    body.dark input,
    body.dark select,
    body.dark button{background:#1a1a1a;color:#eee;border-color:var(--b)}
    body.dark .muted{color:#aaa}
    body.dark .shutter-relay{background:#1d1d1d;color:#bbb;border-color:#333}
    body.dark .pill.shutter{background:#2a2a2a;color:#bbb;border-color:#555}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hr{height:1px;background:var(--b);margin:8px 0}
    .shutter-relay{background:#f2f2f2;color:#777;border-color:#ddd}
    .led{display:inline-block;width:12px;height:12px;border-radius:999px;border:1px solid #bbb;background:#e6e6e6;vertical-align:middle;margin-right:6px}
    .led.on{background:#27c046;border-color:#1aa13a}
  </style>
</head>
<body>
  <h1 data-i18n="page.header">ESPRelay4 - Controller</h1>
  <div class="inline">
    <span id="net" class="pill">ETH: ?</span>
    <span id="hb" class="pill"><span class="hb-dot"></span><span id="uptime">Uptime: --</span></span>
    <span id="msg"></span>
    <span class="lang">
      <button class="flag" id="flag-en" onclick="setLang('en')" title="English">ðŸ‡¬ðŸ‡§</button>
      <button class="flag" id="flag-fr" onclick="setLang('fr')" title="FranÃ§ais">ðŸ‡«ðŸ‡·</button>
      <button class="flag" id="theme_toggle" onclick="toggleTheme()" title="Dark mode">Dark</button>
    </span>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="dash" data-i18n="tabs.dashboard">Dashboard</div>
    <div class="tab" data-tab="prog" data-i18n="tabs.programming">Programming</div>
    <div class="tab" data-tab="json">JSON</div>
    <div class="tab" data-tab="net" data-i18n="tabs.network">Network</div>
    <div class="tab" data-tab="setup" data-i18n="tabs.setup">Setup</div>
    <div class="tab" data-tab="backup" data-i18n="tabs.backup">Backup</div>
  </div>

  <!-- DASHBOARD -->
  <div id="tab-dash">
    <div class="row">
      <div class="card" style="flex:1;min-width:320px">
        <h3 data-i18n="dashboard.login_title">Login</h3>
        <div class="muted" data-i18n="dashboard.login_desc">Login required to modify settings.</div>
        <div class="sep"></div>
        <div class="inline">
          <span id="auth_status" class="pill">Not logged</span>
          <button class="small" id="auth_logout" onclick="logout()" data-i18n="setup.logout" style="display:none;">Logout</button>
        </div>
        <div class="sep"></div>
        <form class="inline" id="auth_form" onsubmit="login(); return false;">
          <span class="muted" data-i18n="setup.user">User</span>
          <input id="auth_user" type="text" placeholder="">
          <span class="muted" data-i18n="setup.pass">Pass</span>
          <input id="auth_pass" type="password" placeholder="">
          <button class="primary" id="auth_login_btn" onclick="login()" data-i18n="setup.login">Login</button>
        </form>
      </div>
    </div>

    <div class="row">
      <div class="card" style="flex:1;min-width:320px">
        <h3 data-i18n="dashboard.inputs">Inputs</h3>
        <div id="inputsView" class="modules">...</div>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="card" style="flex:1;min-width:320px">
        <h3 data-i18n="dashboard.relays">Relays</h3>
        <div id="relaysView" class="modules">...</div>
        <div class="sep"></div>
        <button class="small" onclick="setAllAuto()" data-i18n="dashboard.all_auto">All AUTO</button>
      </div>
    </div>

    <div class="row hide" style="margin-top:12px;" id="tempsRow">
      <div class="card" style="flex:1;min-width:320px">
        <h3 data-i18n="dashboard.temps">Temperatures</h3>
        <div id="tempsView" class="inline">...</div>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="card" style="flex:1;min-width:320px">
        <h3 data-i18n="dashboard.shutters">Shutters</h3>
        <div id="shutterDash" data-i18n="shutter.none">No shutter configured.</div>
      </div>
    </div>
  </div>

  <!-- PROGRAMMATION -->
  <div id="tab-prog" class="hide">
    <div class="inline" style="margin:8px 0 12px 0;">
      <button class="primary" onclick="loadRules()" data-i18n="programming.load_rules">Load rules</button>
      <button class="primary" onclick="saveRules()" data-i18n="programming.save_rules">Save rules</button>
      <span class="muted" data-i18n="programming.flash_note">Rules saved in flash.</span>
    </div>

    <div class="card" style="margin-bottom:12px">
      <h3 data-i18n="programming.simple_rules_title">Simple rules (R1..R4)</h3>
      <div class="muted" data-i18n="programming.simple_rules_desc">FOLLOW / AND / OR / XOR / TOGGLE_RISE / PULSE_RISE + invert + delays.</div>
    </div>

    <div id="rulesGrid" class="grid4"></div>

    <div class="sep"></div>

    <div id="shuttersGrid" class="grid2"></div>
  </div>

  <!-- JSON -->
  <div id="tab-json" class="hide">
    <div class="inline" style="margin:8px 0 12px 0;">
      <button class="primary" onclick="loadRules()" data-i18n="programming.load_rules">Load rules</button>
      <button class="primary" onclick="saveRules()" data-i18n="programming.save_rules">Save rules</button>
      <span class="muted" data-i18n="json.full_view">Full JSON view</span>
    </div>
    <pre id="jsonAll">{}</pre>
  </div>

  <!-- NETWORK -->
  <div id="tab-net" class="hide">
    <div class="card" style="max-width:640px;">
      <h3 data-i18n="network.title">Network configuration</h3>
      <div class="sep"></div>

      <div class="inline">
        <span class="muted" data-i18n="network.mac">MAC</span>
        <span id="net_mac" class="pill">--</span>
      </div>

      <div class="sep"></div>

      <div class="inline">
        <span class="muted" data-i18n="network.mode">Mode</span>
        <select id="net_mode">
          <option value="dhcp" data-i18n="network.mode.dhcp">DHCP</option>
          <option value="static" data-i18n="network.mode.static">Statique</option>
        </select>
      </div>

      <div class="sep"></div>

      <div class="inline">
        <span class="muted" data-i18n="network.ip">IP</span>
        <input id="net_ip" type="text" placeholder="192.168.1.50">
      </div>
      <div class="inline" style="margin-top:8px;">
        <span class="muted" data-i18n="network.gw">Passerelle</span>
        <input id="net_gw" type="text" placeholder="192.168.1.1">
      </div>
      <div class="inline" style="margin-top:8px;">
        <span class="muted" data-i18n="network.mask">Masque</span>
        <input id="net_sn" type="text" placeholder="255.255.255.0">
      </div>
      <div class="inline" style="margin-top:8px;">
        <span class="muted" data-i18n="network.dns">DNS</span>
        <input id="net_dns" type="text" placeholder="192.168.1.1">
      </div>

      <div class="sep"></div>
      <button class="primary" onclick="saveNet()" data-i18n="network.save">Save network</button>
      <span class="muted" id="net_hint"></span>
    </div>

    <div class="card" style="max-width:640px;margin-top:12px;">
      <h3 data-i18n="mqtt.title">MQTT / Home Assistant</h3>
      <div class="muted" data-i18n="mqtt.desc">Broker + topics configuration. Home Assistant auto-discovery.</div>
      <div class="sep"></div>

      <div class="inline">
        <span id="mqtt_status" class="pill">MQTT: ?</span>
      </div>

      <div class="inline">
        <label><input id="mqtt_enabled" type="checkbox"> <span data-i18n="mqtt.enable">Enable MQTT</span></label>
      </div>

      <div class="inline" style="margin-top:8px;">
        <span class="muted" data-i18n="mqtt.broker">Broker</span>
        <input id="mqtt_host" type="text" placeholder="192.168.1.43">
        <span class="muted" data-i18n="mqtt.port">Port</span>
        <input id="mqtt_port" type="number" min="1" max="65535" value="1883">
      </div>

      <div class="inline" style="margin-top:8px;">
        <span class="muted" data-i18n="mqtt.user">User</span>
        <input id="mqtt_user" type="text" placeholder="">
        <span class="muted" data-i18n="mqtt.pass">Pass</span>
        <input id="mqtt_pass" type="password" placeholder="">
      </div>

      <div class="inline" style="margin-top:8px;">
        <span class="muted" data-i18n="mqtt.client_id">Client ID</span>
        <input id="mqtt_client" type="text" placeholder="ESPRelay4">
      </div>

      <div class="inline" style="margin-top:8px;">
        <span class="muted" data-i18n="mqtt.base_topic">Base topic</span>
        <input id="mqtt_base" type="text" placeholder="esprelay4">
      </div>

      <div class="inline" style="margin-top:8px;">
        <span class="muted" data-i18n="mqtt.discovery_prefix">Discovery prefix</span>
        <input id="mqtt_disc" type="text" placeholder="homeassistant">
        <label><input id="mqtt_retain" type="checkbox" checked> <span data-i18n="mqtt.retain">Retain</span></label>
      </div>

      <div class="sep"></div>
      <button class="primary" onclick="saveMqtt()" data-i18n="mqtt.save">Save MQTT</button>
      <span class="muted" id="mqtt_hint"></span>
    </div>

  </div>

  <!-- BACKUP -->
  <div id="tab-setup" class="hide">
    <div class="card" style="max-width:640px;">
      <h3 data-i18n="setup.title">Setup</h3>
      <div class="muted" data-i18n="setup.desc">Login required to modify settings.</div>
      <div class="sep"></div>
      <div class="notice" data-i18n="setup.change_note">Change credentials</div>
      <div class="inline" style="margin-top:8px;">
        <span class="muted" data-i18n="setup.new_user">New user</span>
        <input id="auth_new_user" type="text">
        <span class="muted" data-i18n="setup.new_pass">New pass</span>
        <input id="auth_new_pass" type="password">
        <button class="primary" onclick="saveAuth()" data-i18n="setup.save">Save</button>
      </div>
    </div>
  </div>

  <!-- BACKUP -->
  <div id="tab-backup" class="hide">
    <div class="card" style="max-width:640px;">
      <h3 data-i18n="backup.title">Backup / Restore</h3>
      <div class="muted" data-i18n="backup.desc">Export or import the full configuration (rules + network + MQTT).</div>
      <div class="sep"></div>
      <div class="inline">
        <button class="primary" onclick="downloadBackup()" data-i18n="backup.download">Download backup</button>
        <span id="backup_status" class="muted"></span>
        <button class="small" onclick="document.getElementById('backup_file').click()" data-i18n="backup.import">Import backup</button>
        <input id="backup_file" type="file" accept="application/json" style="display:none">
      </div>
      <div class="muted" style="margin-top:8px;" data-i18n="backup.note">Import can change the IP. Reload the page if needed.</div>
    </div>
  </div>

  <div class="sep"></div>
  <div class="muted" style="text-align:center;">(c) Labotronik 2026</div>

<script>
let i18n = {};
let lang = localStorage.getItem("lang") || "en";
let authUser = localStorage.getItem("auth_user") || "";
let authPass = localStorage.getItem("auth_pass") || "";
let isAuthed = false;
let theme = localStorage.getItem("theme") || "light";

function t(key, fallback){
  return i18n[key] || fallback || key;
}
function tf(key, vars, fallback){
  let s = t(key, fallback);
  if(vars){
    Object.entries(vars).forEach(([k,v])=>{
      s = s.replace(new RegExp(`\\{${k}\\}`, "g"), String(v));
    });
  }
  return s;
}

function setLang(l){
  lang = l || "en";
  localStorage.setItem("lang", lang);
  loadLang(lang);
}

async function loadLang(l){
  try{
    const res = await fetch(`/i18n_${l}.json`, {cache:"no-store"});
    i18n = await res.json();
  }catch(e){
    if(l !== "en") return loadLang("en");
    i18n = {};
  }
  document.documentElement.lang = l;
  applyI18n();
  applyTheme();
  ["en","fr"].forEach(code=>{
    const btn = $("flag-"+code);
    if(btn) btn.classList.toggle("active", code === l);
  });
}

function applyI18n(){
  document.title = t("page.title", "ESPRelay");
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.dataset.i18n;
    if(key) el.textContent = t(key, el.textContent);
  });
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
    const key = el.dataset.i18nPlaceholder;
    if(key) el.setAttribute("placeholder", t(key, el.getAttribute("placeholder") || ""));
  });
}

function applyTheme(){
  document.body.classList.toggle("dark", theme === "dark");
  const btn = $("theme_toggle");
  if(btn){
    btn.textContent = theme === "dark" ? t("theme.light","Light") : t("theme.dark","Dark");
    btn.title = t("theme.title","Dark mode");
  }
}

function toggleTheme(){
  theme = theme === "dark" ? "light" : "dark";
  localStorage.setItem("theme", theme);
  applyTheme();
}

function authHeader(){
  if(!authUser && !authPass) return "";
  return "Basic " + btoa(`${authUser}:${authPass}`);
}

function setAuthState(ok, userLabel=""){
  isAuthed = !!ok;
  const restricted = new Set(["prog","json","net","backup","setup"]);
  document.querySelectorAll(".tab").forEach(tab=>{
    const name = tab.dataset.tab;
    if(restricted.has(name)) tab.classList.toggle("disabled", !isAuthed);
  });
  const status = $("auth_status");
  if(status){
    status.textContent = isAuthed ? tf("setup.logged_as",{user:userLabel || authUser},"Logged in as {user}") : t("setup.not_logged","Not logged");
  }
  const logoutBtn = $("auth_logout");
  if(logoutBtn) logoutBtn.style.display = isAuthed ? "inline-block" : "none";
  const loginBtn = $("auth_login_btn");
  if(loginBtn) loginBtn.style.display = isAuthed ? "none" : "inline-block";
  const form = $("auth_form");
  if(form) form.style.display = isAuthed ? "none" : "inline-flex";
}

async function authCheck(){
  if(!authUser && !authPass){
    setAuthState(false);
    return false;
  }
  try{
    const res = await getAuth();
    setAuthState(true, res.user || authUser);
    return true;
  }catch(e){
    setAuthState(false);
    return false;
  }
}

function requireAuth(){
  if(isAuthed) return true;
  toast(t("toast.login_required","Login required"), false);
  return false;
}

window.login = async ()=>{
  authUser = $("auth_user").value.trim();
  authPass = $("auth_pass").value;
  localStorage.setItem("auth_user", authUser);
  localStorage.setItem("auth_pass", authPass);
  const ok = await authCheck();
  if(ok){
    toast(t("toast.login_ok","Login OK"));
    await loadRules();
    await loadNet();
    await loadMqtt();
    switchTab("dash");
  } else {
    toast(t("toast.login_fail","Login failed"), false);
  }
};

window.logout = ()=>{
  authUser = "";
  authPass = "";
  localStorage.removeItem("auth_user");
  localStorage.removeItem("auth_pass");
  setAuthState(false);
  toast(t("toast.logout","Logged out"));
  switchTab("dash");
};

window.saveAuth = async ()=>{
  if(!requireAuth()) return;
  const user = $("auth_new_user").value.trim();
  const pass = $("auth_new_pass").value;
  if(!user || !pass){
    toast(t("toast.auth_required","User/pass required"), false);
    return;
  }
  try{
    await putAuth({user, pass});
    authUser = user;
    authPass = pass;
    localStorage.setItem("auth_user", authUser);
    localStorage.setItem("auth_pass", authPass);
    setAuthState(true, user);
    toast(t("toast.auth_saved","Credentials saved"));
  }catch(e){
    toast(e.message, false);
  }
};

function getModes(){
  return [
    {id:"FOLLOW", label:t("mode.follow","FOLLOW (1 input)")},
    {id:"AND", label:t("mode.and","AND (multi)")},
    {id:"OR", label:t("mode.or","OR (multi)")},
    {id:"XOR", label:t("mode.xor","XOR (multi)")},
    {id:"TOGGLE_RISE", label:t("mode.toggle_rise","TOGGLE_RISE (rising)")},
    {id:"PULSE_RISE", label:t("mode.pulse_rise","PULSE_RISE (rising)")},
  ];
}

function $(id){ return document.getElementById(id); }
function toast(text, ok=true){
  const m = $("msg");
  m.className = ok ? "ok" : "err";
  m.textContent = ok ? `âœ… ${text}` : `âŒ ${text}`;
  const ms = ok ? 2500 : 6000;
  setTimeout(()=>{ m.textContent=""; m.className=""; }, ms);
}
function switchTab(name){
  const restricted = new Set(["prog","json","net","backup"]);
  if(restricted.has(name) && !isAuthed){
    toast(t("toast.login_required","Login required"), false);
    name = "dash";
  }
  for(const t of ["dash","prog","json","net","setup","backup"]){
    $("tab-"+t).classList.toggle("hide", t!==name);
    document.querySelector(`.tab[data-tab="${t}"]`).classList.toggle("active", t===name);
  }
  if(name === "prog" && rules) renderSimpleRules();
  if(name === "net") { loadNet(); loadMqtt(); }
}
document.querySelectorAll(".tab").forEach(el=>{
  el.addEventListener("click", ()=>switchTab(el.dataset.tab));
});

// -------- API helpers --------
async function apiJson(path, opts){
  const inOpts = opts || {};
  const options = Object.assign({cache:"no-store"}, inOpts);
  options.headers = Object.assign({}, inOpts.headers || {});
  const auth = authHeader();
  if(auth && !options.headers.Authorization) options.headers.Authorization = auth;
  const r = await fetch(path, options);
  const ct = r.headers.get("content-type") || "";
  const raw = await r.text();
  if(!r.ok){
    let errText = raw;
    if(ct.includes("application/json")){
      try{ errText = JSON.stringify(JSON.parse(raw)); }catch(e){ /* keep raw */ }
    }
    throw new Error(`${r.status} ${r.statusText} - ${errText}`);
  }
  if(ct.includes("application/json")){
    try{
      return JSON.parse(raw);
    }catch(e){
      const start = raw.indexOf("{");
      const end = raw.lastIndexOf("}");
      if(start >= 0 && end > start){
        try{ return JSON.parse(raw.slice(start, end+1)); }catch(e2){ /* ignore */ }
      }
      // Fallback: parse simple key/value lines (e.g. "key\tvalue")
      const obj = {};
      raw.split(/\r?\n/).forEach(line=>{
        const l = line.trim();
        if(!l) return;
        const parts = l.split(/\s+|\t+/);
        if(parts.length < 2) return;
        const key = parts.shift();
        let val = parts.join(" ").trim();
        if(val.startsWith("\"") && val.endsWith("\"")) val = val.slice(1, -1);
        if(/^(true|false)$/i.test(val)) obj[key] = /true/i.test(val);
        else if(/^-?\d+(\.\d+)?$/.test(val)) obj[key] = Number(val);
        else obj[key] = val;
      });
      if(Object.keys(obj).length) return obj;
      throw new Error("invalid json");
    }
  }
  return raw;
}
const getState = ()=>apiJson("/api/state");
const getAuth = ()=>apiJson("/api/auth");
const getRules = ()=>apiJson("/api/rules");
const putRules = (body)=>apiJson("/api/rules",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
const postOverride = (relay, mode)=>apiJson("/api/override",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({relay,mode})});
const postShutter = (cmd,id=1)=>apiJson("/api/shutter",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cmd,id})});
const getNet = ()=>apiJson("/api/net");
const putNet = (body)=>apiJson("/api/net",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
const getMqtt = ()=>apiJson("/api/mqtt");
const putMqtt = (body)=>apiJson("/api/mqtt",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
const getBackup = ()=>apiJson("/api/backup");
const putBackup = (body)=>apiJson("/api/backup",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
const putAuth = (body)=>apiJson("/api/auth",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});

// -------- data model --------
let rules = null;
let lastState = null;
let netCfg = null;
let mqttCfg = null;
let mqttDirty = false;
let totalRelays = 4;
let totalInputs = 4;

function defaultRules(){
  const rCount = totalRelays || 4;
  const iCount = totalInputs || 4;
  return {
    version: 2,
    relays: Array.from({length:rCount}).map((_,i)=>(
      { expr:{op:"FOLLOW", in: (i+1<=iCount?i+1:1)}, invert:false, onDelay:0, offDelay:0, pulseMs:200 }
    )),
    shutters: []
  };
}

function ensureRulesBase(r){
  if(!r || typeof r!=="object") r = defaultRules();
  if(!r.version) r.version = 2;
  if(!Array.isArray(r.relays)) r.relays = defaultRules().relays;
  if(r.relays.length !== (totalRelays || r.relays.length)){
    const d = defaultRules();
    r.relays = d.relays;
  }
  if(!Array.isArray(r.shutters)) r.shutters = [];
  return r;
}

function updateTotalsFromState(s){
  if(!s) return;
  if(typeof s.total_relays === "number") totalRelays = s.total_relays;
  if(typeof s.total_inputs === "number") totalInputs = s.total_inputs;
}

function getShutterRelaySet(){
  const set = new Set();
  const shs = rules?.shutters || [];
  shs.slice(0, maxShutters()).forEach(sh=>{
    if(!sh || typeof sh !== "object") return;
    const up = Number(sh.up_relay);
    const down = Number(sh.down_relay);
    if(Number.isFinite(up)) set.add(up);
    if(Number.isFinite(down)) set.add(down);
  });
  return set;
}

// -------- Simple rules editor --------
function selectedInputsForRelay(i){
  const cbs = document.querySelectorAll(`input[type="checkbox"][data-ri="${i}"][data-in]`);
  const ins = [];
  cbs.forEach(cb=>{ if(cb.checked) ins.push(Number(cb.dataset.in)); });
  return ins;
}

function normalizeRelayExpr(i){
  const r = rules.relays[i];
  if(!r.expr) r.expr = {op:"FOLLOW", in:1};
  const op = r.expr.op || "FOLLOW";
  const ins = selectedInputsForRelay(i);

  if(op==="FOLLOW" || op==="TOGGLE_RISE" || op==="PULSE_RISE"){
    r.expr = {op, in: ins[0] || (r.expr.in || 1)};
  } else {
    r.expr = {op, ins: (ins.length ? ins : (r.expr.ins || [1]))};
  }
  // conserver pulseMs dans la rÃ¨gle (Ã  plat, comme ton firmware actuel peut le lire ou non)
  if(r.pulseMs === undefined) r.pulseMs = 200;
}

function ruleCard(i, r, isShutterRelay){
  if(!r.expr) r.expr = {op:"FOLLOW", in:1};
  const op = r.expr.op || "FOLLOW";
  const checked = new Set();
  if(op==="FOLLOW" || op==="TOGGLE_RISE" || op==="PULSE_RISE"){
    checked.add(r.expr.in || 1);
  } else {
    (r.expr.ins || []).forEach(x=>checked.add(x));
  }

  const modeOptions = getModes().map(m => `<option value="${m.id}" ${m.id===op?"selected":""}>${m.label}</option>`).join("");

  const inputsHtml = Array.from({length: totalInputs || 4}).map((_,idx)=>{
    const n = idx + 1;
    return `
      <label style="margin-right:10px;">
        <input type="checkbox" data-ri="${i}" data-in="${n}" ${checked.has(n)?"checked":""} onchange="onInputsChanged(event)" ${isShutterRelay ? "disabled" : ""}>
        E${n}
      </label>`;
  }).join("");

  const inv = !!r.invert;
  const onDelay = Number(r.onDelay||0);
  const offDelay = Number(r.offDelay||0);
  const pulseMs = Number(r.pulseMs||200);

  const pulseRow = (op==="PULSE_RISE")
    ? `<div class="inline" style="margin-top:8px;">
         <span class="muted">${t("rule.pulse_ms","pulseMs")}</span>
         <input type="number" min="10" max="60000" value="${pulseMs}" data-ri="${i}" data-field="pulseMs" onchange="onFieldChanged(event)" ${isShutterRelay ? "disabled" : ""}>
         <span class="muted">ms</span>
       </div>`
    : "";

  const shutterBadge = isShutterRelay ? `<span class="pill shutter" style="margin-left:6px;">${t("shutter.badge","SHUTTER")}</span>` : "";
  return `
    <div class="card ${isShutterRelay ? "shutter-relay" : ""}">
      <h3>${tf("rule.relay_title",{n:i+1},"Relay R{n}")} ${shutterBadge}</h3>

      <div class="inline">
        <span class="muted">${t("rule.mode","Mode")}</span>
        <select data-ri="${i}" data-field="op" onchange="onModeChanged(event)" ${isShutterRelay ? "disabled" : ""}>${modeOptions}</select>
      </div>

      <div class="hr"></div>

      <div><b>${t("rule.inputs","Inputs")}</b></div>
      <div class="inline" style="margin-top:6px;">${inputsHtml}</div>
      <div class="muted" style="margin-top:6px;">${t("rule.inputs_hint","FOLLOW/TOGGLE/PULSE = 1 input. AND/OR/XOR = multiple.")}</div>

      <div class="hr"></div>

      <div class="inline">
        <label><input type="checkbox" data-ri="${i}" data-field="invert" ${inv?"checked":""} onchange="onInvertChanged(event)" ${isShutterRelay ? "disabled" : ""}> ${t("rule.invert","Invert")}</label>
      </div>

      <div class="hr"></div>

      <div class="inline">
        <span class="muted">${t("rule.on_delay","onDelay")}</span>
        <input type="number" min="0" max="600000" value="${onDelay}" data-ri="${i}" data-field="onDelay" onchange="onFieldChanged(event)" ${isShutterRelay ? "disabled" : ""}>
        <span class="muted">ms</span>
      </div>

      <div class="inline" style="margin-top:8px;">
        <span class="muted">${t("rule.off_delay","offDelay")}</span>
        <input type="number" min="0" max="600000" value="${offDelay}" data-ri="${i}" data-field="offDelay" onchange="onFieldChanged(event)" ${isShutterRelay ? "disabled" : ""}>
        <span class="muted">ms</span>
      </div>

      ${pulseRow}

      <div class="hr"></div>

      <button class="small" onclick="applyOne(${i})" ${isShutterRelay ? "disabled" : ""}>${tf("rule.apply",{n:i+1},"Apply R{n}")}</button>
    </div>
  `;
}

function renderSimpleRules(){
  const shRelays = getShutterRelaySet();
  $("rulesGrid").innerHTML = rules.relays.map((r,i)=>ruleCard(i,r, shRelays.has(i+1))).join("");
}

window.onModeChanged = (ev)=>{
  const i = Number(ev.target.dataset.ri);
  const op = ev.target.value;
  rules.relays[i].expr = rules.relays[i].expr || {};
  rules.relays[i].expr.op = op;
  normalizeRelayExpr(i);
  renderAll();
};
window.onInputsChanged = (ev)=>{
  const i = Number(ev.target.dataset.ri);
  normalizeRelayExpr(i);
  renderJsonBoxes();
};
window.onInvertChanged = (ev)=>{
  const i = Number(ev.target.dataset.ri);
  rules.relays[i].invert = ev.target.checked;
  renderJsonBoxes();
};
window.onFieldChanged = (ev)=>{
  const i = Number(ev.target.dataset.ri);
  const field = ev.target.dataset.field;
  rules.relays[i][field] = Number(ev.target.value||0);
  renderJsonBoxes();
};
window.applyOne = async (i)=>{
  if(!requireAuth()) return;
  try{
    normalizeRelayExpr(i);
    await putRules(rules);
    toast(tf("toast.rule_applied",{n:i+1},"Rules applied (R{n})"));
    await loadRules();
  }catch(e){
    toast(e.message, false);
  }
};

// -------- Shutter (additive) --------
function fillSelect(id, prefix, n){
  const sel = $(id);
  sel.innerHTML = "";
  for(let i=1;i<=n;i++){
    const o = document.createElement("option");
    o.value = String(i);
    o.textContent = `${prefix}${i}`;
    sel.appendChild(o);
  }
}

function maxShutters(){
  return Math.max(1, Math.floor((totalRelays || 4) / 2));
}

function shId(idx, field){
  return `sh${idx+1}_${field}`;
}

function renderShutterCards(){
  const grid = $("shuttersGrid");
  if(!grid) return;
  const count = maxShutters();
  const cards = [];
  for(let i=0;i<count;i++){
    cards.push(`
      <div class="card">
        <h3>${tf("shutter.title",{n:i+1},"Shutter {n}")}</h3>
        <div class="muted">${tf("shutter.desc",{n:i+1},"Shutter {n} (2 relays). Relays must not overlap.")}</div>
        <div class="sep"></div>

        <div class="inline">
          <span class="muted">${t("shutter.name","Name")}</span>
          <input id="${shId(i,"name")}" type="text" value="${tf("shutter.default_name",{n:i+1},"Shutter {n}")}" />
        </div>

        <div class="sep"></div>

        <div class="two">
          <div>
            <div class="muted"><b>${t("shutter.cmd_up","UP command")}</b></div>
            <div class="inline" style="margin-top:6px;">
              <span class="muted">${t("shutter.input","Input")}</span>
              <select id="${shId(i,"up_in")}"></select>
            </div>
            <div class="inline" style="margin-top:6px;">
              <span class="muted">${t("shutter.relay","Relay")}</span>
              <select id="${shId(i,"up_relay")}"></select>
            </div>
          </div>

          <div>
            <div class="muted"><b>${t("shutter.cmd_down","DOWN command")}</b></div>
            <div class="inline" style="margin-top:6px;">
              <span class="muted">${t("shutter.input","Input")}</span>
              <select id="${shId(i,"down_in")}"></select>
            </div>
            <div class="inline" style="margin-top:6px;">
              <span class="muted">${t("shutter.relay","Relay")}</span>
              <select id="${shId(i,"down_relay")}"></select>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="inline">
          <span class="muted">${t("shutter.mode","Mode")}</span>
          <select id="${shId(i,"mode")}">
            <option value="hold">${t("shutter.mode_hold","hold (momentary)")}</option>
            <option value="toggle">${t("shutter.mode_toggle","toggle (press = run/stop)")}</option>
          </select>
        </div>

        <div class="inline" style="margin-top:8px;">
          <span class="muted">${t("shutter.priority","Priority when 2 buttons")}</span>
          <select id="${shId(i,"priority")}">
            <option value="stop">${t("shutter.priority_stop","stop (recommended)")}</option>
            <option value="up">${t("shutter.priority_up","up")}</option>
            <option value="down">${t("shutter.priority_down","down")}</option>
          </select>
        </div>

        <div class="inline" style="margin-top:8px;">
          <span class="muted">${t("shutter.dead_time","Dead-time")}</span>
          <input id="${shId(i,"dead")}" type="number" min="0" max="5000" value="400" />
          <span class="muted">ms</span>
        </div>

        <div class="inline" style="margin-top:8px;">
          <span class="muted">${t("shutter.max_time","Max time")}</span>
          <input id="${shId(i,"max")}" type="number" min="0" max="120000" value="25000" />
          <span class="muted">${t("shutter.max_time_off","ms (0 = disabled)")}</span>
        </div>

        <div class="sep"></div>
        <button class="primary" onclick="applyShutter(${i})">${t("shutter.add_update","Add / Update")}</button>
        <button class="small" onclick="removeShutter(${i})">${t("shutter.remove","Remove shutter")}</button>
      </div>
    `);
  }
  grid.innerHTML = cards.join("");

  for(let i=0;i<count;i++){
    fillSelect(shId(i,"up_in"), "E", totalInputs || 4);
    fillSelect(shId(i,"down_in"), "E", totalInputs || 4);
    fillSelect(shId(i,"up_relay"), "R", totalRelays || 4);
    fillSelect(shId(i,"down_relay"), "R", totalRelays || 4);
  }

  for(let i=0;i<count;i++){
    const def = {
      name: tf("shutter.default_name",{n:i+1},"Shutter {n}"),
      up_in: 1,
      down_in: 2,
      up_relay: (i*2)+1,
      down_relay: (i*2)+2,
      mode: "hold",
      priority: "stop",
      deadtime_ms: 400,
      max_run_ms: 25000
    };
    const sh = rules?.shutters?.[i] || def;
    setUIFromShutter(i, sh);
  }
}

function shutterFromUI(idx){
  const p = `sh${idx+1}_`;
  return {
    name: $(p+"name").value || tf("shutter.default_name",{n:idx+1},"Shutter {n}"),
    up_in: Number($(p+"up_in").value),
    down_in: Number($(p+"down_in").value),
    up_relay: Number($(p+"up_relay").value),
    down_relay: Number($(p+"down_relay").value),
    mode: $(p+"mode").value,
    priority: $(p+"priority").value,
    deadtime_ms: Number($(p+"dead").value||0),
    max_run_ms: Number($(p+"max").value||0)
  };
}
function setUIFromShutter(idx, sh){
  const p = `sh${idx+1}_`;
  $(p+"name").value = sh.name || tf("shutter.default_name",{n:idx+1},"Shutter {n}");
  $(p+"up_in").value = String(sh.up_in || 1);
  $(p+"down_in").value = String(sh.down_in || 2);
  $(p+"up_relay").value = String(sh.up_relay || (idx*2 + 1));
  $(p+"down_relay").value = String(sh.down_relay || (idx*2 + 2));
  $(p+"mode").value = sh.mode || "hold";
  $(p+"priority").value = sh.priority || "stop";
  $(p+"dead").value = String(sh.deadtime_ms ?? 400);
  $(p+"max").value = String(sh.max_run_ms ?? 25000);
}

async function applyShutter(idx){
  if(!requireAuth()) return;
  try{
    if(idx >= maxShutters()) return;
    const sh = shutterFromUI(idx);
    if(sh.up_relay === sh.down_relay){
      toast(t("toast.shutter_same_relay","UP relay and DOWN relay must be different"), false);
      return;
    }
    if(!Array.isArray(rules.shutters)) rules.shutters = [];
    if(rules.shutters.length <= idx) rules.shutters.length = idx + 1;
    rules.shutters[idx] = sh;
    await putRules(rules);
    toast(t("toast.shutter_saved","Shutter added / updated"));
    await loadRules();
  }catch(e){
    toast(e.message, false);
  }
}
async function removeShutter(idx){
  if(!requireAuth()) return;
  try{
    if(idx >= maxShutters()) return;
    if(!Array.isArray(rules.shutters)) rules.shutters = [];
    rules.shutters[idx] = null;
    while(rules.shutters.length && (rules.shutters[rules.shutters.length-1] == null)) rules.shutters.pop();
    await putRules(rules);
    toast(t("toast.shutter_removed","Shutter removed"));
    await loadRules();
  }catch(e){
    toast(e.message, false);
  }
}

// -------- Dashboard rendering --------
function renderState(s){
  lastState = s;
  if(s.eth){
    $("net").textContent = s.eth.ip || "";
  }
  if(typeof s.uptime_ms === "number"){
    $("uptime").textContent = `${t("uptime.label","Uptime")}: ${formatUptime(s.uptime_ms)}`;
  }
  updateTotalsFromState(s);

  const inCols = [];
  const inModules = Math.max(1, Math.ceil((s.inputs?.length || 0) / 4));
  for(let m=0; m<inModules; m++){
    const base = m*4;
    const slice = s.inputs.slice(base, base+4);
    const chips = slice.map((v,i)=>
      `<span class="chip">E${base+i+1}: <span class="${v?'on':''}">${v?t("state.on","ON"):t("state.off","OFF")}</span></span>`
    ).join("");
    inCols.push(`<div class="module-card"><b>${tf("module.title",{n:m+1},"Module {n}")}</b><div class="sep"></div><div class="inline">${chips}</div></div>`);
  }
  $("inputsView").innerHTML = inCols.join("");

  const shRelays = getShutterRelaySet();
  const reCols = [];
  const reModules = Math.max(1, Math.ceil((s.relays?.length || 0) / 4));
  for(let m=0; m<reModules; m++){
    const base = m*4;
    const slice = s.relays.slice(base, base+4);
    const items = slice.map((v,off)=>{
      const i = base + off;
      const isShutterRelay = shRelays.has(i+1);
      const ov = (s.override && s.override[i] !== undefined) ? s.override[i] : -1;
      const modeLabel = ov===-1 ? t("relay.auto","AUTO") : (ov===1 ? t("relay.force_on","FORCE ON") : t("relay.force_off","FORCE OFF"));
      const badge = isShutterRelay ? `<span class="pill shutter" style="margin-left:6px;">${t("shutter.badge","SHUTTER")}</span>` : "";
      const ledClass = v ? "led on" : "led";
      const stateHtml = isShutterRelay ? "" : `<span class="${v?'on':''}">${v?t("state.on","ON"):t("state.off","OFF")}</span>`;
      const modeHtml = isShutterRelay ? "" : `<span class="pill">${modeLabel}</span>`;
      const overrideHtml = isShutterRelay ? "" : `
          <div style="margin-top:6px;">
            <button class="small" onclick="setOverride(${i+1},'AUTO')">${t("relay.auto","AUTO")}</button>
            <button class="small" onclick="setOverride(${i+1},'FORCE_ON')">${t("relay.on","ON")}</button>
            <button class="small" onclick="setOverride(${i+1},'FORCE_OFF')">${t("relay.off","OFF")}</button>
          </div>
      `;
      return `
        <div class="${isShutterRelay ? "shutter-relay" : ""}" style="margin:8px 0;">
          <span class="${ledClass}"></span><b>R${i+1}</b>${badge} :
          ${stateHtml}
          ${modeHtml}
          ${overrideHtml}
        </div>
        <div class="hr"></div>
      `;
    }).join("");
    reCols.push(`<div class="module-card"><b>${tf("module.title",{n:m+1},"Module {n}")}</b><div class="sep"></div>${items}</div>`);
  }
  $("relaysView").innerHTML = reCols.join("");

  renderShutterDash();

  const tempsRow = $("tempsRow");
  const tempsView = $("tempsView");
  if(s.temps && s.temps.length){
    tempsRow.classList.remove("hide");
    tempsView.innerHTML = s.temps.map(t=>{
      const v = (typeof t.c === "number") ? `${t.c.toFixed(2)} Â°C` : "--";
      const h = (typeof t.h === "number") ? ` â€¢ ${t.h.toFixed(1)} %` : "";
      return `<span class="chip">${t.addr}: <span class="on">${v}${h}</span></span>`;
    }).join("");
  } else {
    tempsRow.classList.add("hide");
  }
}

function formatUptime(ms){
  const total = Math.floor(ms/1000);
  const d = Math.floor(total/86400);
  const h = Math.floor((total%86400)/3600);
  const m = Math.floor((total%3600)/60);
  const s = total%60;
  if(d>0) return `${d}${t("uptime.days_short","d")} ${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

async function setOverride(relay, mode){
  if(!requireAuth()) return;
  try{ await postOverride(relay, mode); toast(tf("toast.override",{n:relay,mode},"R{n} -> {mode}")); }
  catch(e){ toast(e.message, false); }
}
async function setAllAuto(){
  if(!requireAuth()) return;
  try{ for(let i=1;i<=totalRelays;i++) await postOverride(i,"AUTO"); toast(t("toast.all_auto","All AUTO")); }
  catch(e){ toast(e.message, false); }
}

function renderShutterDash(){
  const shs = rules?.shutters || [];
  const hasAny = shs.slice(0, maxShutters()).some(sh=>sh && typeof sh === "object");
  if(!hasAny){
    $("shutterDash").textContent = t("shutter.none","No shutter configured.");
    return;
  }
  const parts = [];
  for(let idx=0; idx<maxShutters(); idx++){
    const sh = shs[idx];
    if(!sh || typeof sh !== "object") continue;
    parts.push(`
      <div class="inline">
        <span class="pill">${sh.name || tf("shutter.default_name",{n:idx+1},"Shutter {n}")}</span>
        <span class="muted">${tf("shutter.relay_map",{up:sh.up_relay,down:sh.down_relay},"UP=R{up} / DOWN=R{down}")}</span>
      </div>
      <div class="sep"></div>
      <div class="inline">
        <button class="primary" onclick="shutterUp(${idx+1})">${t("shutter.up","UP")}</button>
        <button class="primary" onclick="shutterStop(${idx+1})">${t("shutter.stop","STOP")}</button>
        <button class="primary" onclick="shutterDown(${idx+1})">${t("shutter.down","DOWN")}</button>
      </div>
      <div class="muted" style="margin-top:8px">
        ${t("shutter.command_hint","Command via shutter API.")}
      </div>
      ${idx === maxShutters()-1 ? "" : "<div class=\"sep\"></div>"}
    `);
  }
  $("shutterDash").innerHTML = parts.join("");
}
async function shutterStop(id){
  if(!requireAuth()) return;
  const sh = rules?.shutters?.[id-1]; if(!sh) return;
  await postShutter("STOP", id);
  await refreshState();
}
async function shutterUp(id){
  if(!requireAuth()) return;
  const sh = rules?.shutters?.[id-1]; if(!sh) return;
  await postShutter("UP", id);
  await refreshState();
}
async function shutterDown(id){
  if(!requireAuth()) return;
  const sh = rules?.shutters?.[id-1]; if(!sh) return;
  await postShutter("DOWN", id);
  await refreshState();
}

// -------- JSON boxes --------
function renderJsonBoxes(){
  const jb = $("jsonBox");
  if(jb) jb.textContent = JSON.stringify(rules, null, 2);
  $("jsonAll").textContent = JSON.stringify(rules, null, 2);
}

// -------- Load / Save --------
function renderAll(){
  renderSimpleRules();
  renderJsonBoxes();
  renderShutterCards();
  renderShutterDash();
}

// -------- Network config --------
function setNetUI(cfg){
  $("net_mode").value = cfg.mode || "static";
  $("net_ip").value = cfg.ip || "";
  $("net_gw").value = cfg.gw || "";
  $("net_sn").value = cfg.sn || "";
  $("net_dns").value = cfg.dns || "";
  $("net_mac").textContent = cfg.mac || "--";
  updateNetUiState();
}

function updateNetUiState(){
  const dhcp = $("net_mode").value === "dhcp";
  ["net_ip","net_gw","net_sn","net_dns"].forEach(id=>{
    $(id).disabled = dhcp;
  });
  $("net_hint").textContent = dhcp ? t("network.dhcp_enabled","DHCP enabled") : "";
}

function readNetUI(){
  return {
    mode: $("net_mode").value,
    ip: $("net_ip").value.trim(),
    gw: $("net_gw").value.trim(),
    sn: $("net_sn").value.trim(),
    dns: $("net_dns").value.trim()
  };
}

async function loadNet(){
  if(!isAuthed) return;
  try{
    netCfg = await getNet();
    if(!netCfg || (netCfg.mode !== "dhcp" && netCfg.mode !== "static")){
      netCfg = {mode:"static", ip:"", gw:"", sn:"", dns:""};
    }
    setNetUI(netCfg);
  }catch(e){
    toast(t("toast.net_unavailable","GET /api/net unavailable"), false);
  }
}

async function saveNet(){
  if(!requireAuth()) return;
  try{
    const body = readNetUI();
    await putNet(body);
    toast(t("toast.net_saved","Network saved"));
    await loadNet();
  }catch(e){
    toast(e.message, false);
  }
}

$("net_mode").addEventListener("change", updateNetUiState);

// -------- MQTT config --------
function setMqttUI(cfg){
  $("mqtt_enabled").checked = !!cfg.enabled;
  $("mqtt_host").value = cfg.host || "192.168.1.43";
  $("mqtt_port").value = cfg.port || 1883;
  $("mqtt_user").value = cfg.user || "";
  $("mqtt_pass").value = cfg.pass || "";
  $("mqtt_client").value = cfg.client_id || "ESPRelay4";
  $("mqtt_base").value = cfg.base || "esprelay4";
  $("mqtt_disc").value = cfg.discovery_prefix || "homeassistant";
  $("mqtt_retain").checked = cfg.retain !== 0;
  const status = cfg.connected ? t("mqtt.connected","Connected") : t("mqtt.disconnected","Disconnected");
  $("mqtt_status").textContent = `${t("mqtt.status","MQTT")}: ${status}`;
  $("mqtt_hint").textContent = cfg.enabled ? "" : t("mqtt.disabled","MQTT disabled");
  mqttDirty = false;
}

function readMqttUI(){
  return {
    enabled: $("mqtt_enabled").checked ? 1 : 0,
    host: $("mqtt_host").value.trim(),
    port: Number($("mqtt_port").value||1883),
    user: $("mqtt_user").value.trim(),
    pass: $("mqtt_pass").value.trim(),
    client_id: $("mqtt_client").value.trim(),
    base: $("mqtt_base").value.trim(),
    discovery_prefix: $("mqtt_disc").value.trim(),
    retain: $("mqtt_retain").checked ? 1 : 0
  };
}

async function loadMqtt(){
  if(!isAuthed) return;
  try{
    mqttCfg = await getMqtt();
    if(!mqttCfg || mqttCfg.host === undefined){
      mqttCfg = {
        enabled:0, host:"192.168.1.43", port:1883, user:"", pass:"",
        client_id:"ESPRelay4", base:"esprelay4", discovery_prefix:"homeassistant", retain:1
      };
    }
    if(!mqttDirty) setMqttUI(mqttCfg);
    else {
      const status = mqttCfg.connected ? t("mqtt.connected","Connected") : t("mqtt.disconnected","Disconnected");
      $("mqtt_status").textContent = `${t("mqtt.status","MQTT")}: ${status}`;
    }
  }catch(e){
    console.warn("MQTT fetch failed", e);
    const status = mqttCfg?.connected ? t("mqtt.connected","Connected") : t("mqtt.disconnected","Disconnected");
    if($("mqtt_status")) $("mqtt_status").textContent = `${t("mqtt.status","MQTT")}: ${status}`;
    if($("mqtt_hint")) $("mqtt_hint").textContent = t("toast.mqtt_unavailable","GET /api/mqtt unavailable");
  }
}

async function saveMqtt(){
  if(!requireAuth()) return;
  try{
    const body = readMqttUI();
    await putMqtt(body);
    toast(t("toast.mqtt_saved","MQTT saved"));
    mqttDirty = false;
    await loadMqtt();
  }catch(e){
    toast(e.message, false);
  }
}

["mqtt_enabled","mqtt_host","mqtt_port","mqtt_user","mqtt_pass","mqtt_client","mqtt_base","mqtt_disc","mqtt_retain"]
  .forEach(id => $(id).addEventListener("input", ()=>{ mqttDirty = true; }));

// -------- Backup / Restore --------
async function downloadBackup(){
  if(!requireAuth()) return;
  try{
    $("backup_status").textContent = "";
    const data = await getBackup();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "esprelay4-backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }catch(e){
    toast(e.message, false);
  }
}

$("backup_file").addEventListener("change", async (ev)=>{
  if(!requireAuth()) return;
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  try{
    const text = await f.text();
    const json = JSON.parse(text);
    const res = await putBackup(json);
    if(res && res.reboot){
      $("backup_status").textContent = t("backup.status.ok_reboot","Import OK, rebootingâ€¦");
    } else {
      $("backup_status").textContent = t("backup.status.ok","Import OK");
    }
    await loadRules();
    await loadNet();
    await loadMqtt();
  }catch(e){
    toast(e.message, false);
    $("backup_status").textContent = t("backup.status.fail","Import failed");
  } finally {
    ev.target.value = "";
  }
});

async function loadRules(){
  if(!isAuthed) return;
  try{
    if(!lastState){
      try{
        const s = await getState();
        renderState(s);
      }catch(e){ /* ignore */ }
    }
    rules = ensureRulesBase(await getRules());
    toast(t("toast.rules_loaded","Rules loaded"));
  }catch(e){
    rules = ensureRulesBase(defaultRules());
    toast(t("toast.rules_unavailable","GET /api/rules unavailable (fallback)"), false);
  }

  renderShutterCards();

  renderAll();
  if(lastState) renderState(lastState);
}

async function saveRules(){
  if(!requireAuth()) return;
  try{
    // normaliser toutes les expressions avant envoi
    for(let i=0;i<rules.relays.length;i++) normalizeRelayExpr(i);
    await putRules(rules);
    toast(t("toast.rules_saved","Rules saved"));
    await loadRules();
  }catch(e){
    toast(e.message, false);
  }
}

// -------- Live refresh --------
async function refreshState(){
  try{
    const s = await getState();
    renderState(s);
  }catch(e){
    $("net").textContent = "ETH: ?";
  }
}

setInterval(refreshState, 600);
async function init(){
  await loadLang(lang);
  applyTheme();
  if($("auth_user")) $("auth_user").value = "";
  if($("auth_pass")) $("auth_pass").value = "";
  await authCheck();
  if(isAuthed) loadRules();
  refreshState();
  if(isAuthed){ loadNet(); loadMqtt(); }
  setInterval(()=>{
    const netTab = $("tab-net");
    if(netTab && !netTab.classList.contains("hide")) loadMqtt();
  }, 5000);
}
init();
</script>
</body>
</html>
